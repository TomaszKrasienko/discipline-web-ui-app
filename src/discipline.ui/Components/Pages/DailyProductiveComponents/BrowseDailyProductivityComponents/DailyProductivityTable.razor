@page "/daily-productivity"
@using BlazorBootstrap
@using discipline.ui.Components.Common.HeadersComponents
@using discipline.core.Dispatchers.Abstractions
@using discipline.core.DTOs
@using discipline.ui.Components.Pages.DailyProductive.BrowseDailyProductivity.TableComponent
@using discipline.ui.Components.Common.ButtonsComponents
@using discipline.ui.Components.Pages.DailyProductiveComponents.ActivityFormComponents
@inject IDailyProductivityDispatcher DailyProductivityDisciplineAppDispatcher
@rendermode InteractiveServer

<PageTitle>Daily productivity</PageTitle>
<PageHeader Title="Daily productivity"/>
<div class="row text-center">
    <div class="col-md-4 offset-4">
        <DateInput 
            TValue="DateOnly" 
            Id="daily-productivity-day"
            Value="_day"
            ValueExpression="() => _day"
            ValueChanged="OnDateChanged"/>
    </div>
</div>
<div class="row pt-5">
    <div class="col-md-6 offset-2 mx-auto">
        @if (_dailyProductivity is not null)
        {
            @foreach (var activity in _dailyProductivity?.Activities!)
            {
                <div class="row">
                    <ActivityTableRow 
                        Activity="activity" 
                        OnActivityRowClick="async () => await ChangeCheck(activity)"
                        OnDeleteActivityCallback="InitializeAsync"/>
                </div>
            }
        }
    </div>
</div>

<CreateNewButton 
    OnClickCallback="ShowCreateNewFormAsync"/>

<ActivityFormModal
    @ref="_activityFormModal"
    Day="_day"
    OnHidingEventCallback="InitializeAsync"/>

@code {
    private DateOnly _day = DateOnly.FromDateTime(DateTime.Now.Date);
    private DailyProductivityDto? _dailyProductivity;
    private ActivityFormModal _activityFormModal = default!;

    protected override async Task OnParametersSetAsync()
        => await InitializeAsync();

    private async Task InitializeAsync()
            => _dailyProductivity = await DailyProductivityDisciplineAppDispatcher.GetDailyProductivityByDay(_day);

    private async Task OnDateChanged()
    {
        
    }

    private async Task ChangeCheck(ActivityDto activity)
    {
        var response = await DailyProductivityDisciplineAppDispatcher.ChangeActivityCheck(activity.Id);
        if (response.IsValid)
        {
            activity.IsChecked = !activity.IsChecked;
        }
    }

    private async Task ShowCreateNewFormAsync()
        => await _activityFormModal.ShowModalAsync();

}